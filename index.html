<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kapitler — Spillelister</title>

  <!-- Typografi -->
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@300;400;500;600&family=Newsreader:ital,wght@1,400;1,500&display=swap" rel="stylesheet">

  <style>
    :root{
      --paper:#F1E3CF;   /* krem bakgrunn */
      --ink:#111111;     /* blekk/svart */
      --muted:#3D3A36;   /* dempet gråbrun */
      --maxw:1120px;
      --radius:10px;
      --shadow:0 12px 28px rgba(0,0,0,.12);
      --gap:26px;
      --in-dur:.7s;
      --in-ease:cubic-bezier(.21,.98,.6,.99);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{ margin:0; background:var(--paper); color:var(--ink); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; line-height:1.65; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility }

    /* Bakgrunn med tekstur og animasjon */
    body::before, body::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:0}
    body::before{background:radial-gradient(120% 120% at 75% 15%, rgba(0,0,0,.06), transparent 55%),radial-gradient(140% 120% at 10% 90%, rgba(0,0,0,.05), transparent 55%);mix-blend-mode:multiply;opacity:.28;animation:vignetteDrift 18s ease-in-out infinite alternate}
    @keyframes vignetteDrift{to{transform:translateY(-1.5%)}}
    body::after{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="180" height="180"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.25"/></svg>');opacity:.12;mix-blend-mode:multiply;animation:grainSlide 6s linear infinite}
    @keyframes grainSlide{to{transform:translateX(-2%)}}

    .container{position:relative;z-index:1;max-width:var(--maxw);margin:0 auto;padding:48px 20px 24px}

    header.brev{text-align:center;padding-top:56px}
    .brev h1{font-family:"Archivo Black",sans-serif;font-weight:400;letter-spacing:.01em;font-size:clamp(2rem,3.2vw,2.6rem);margin:0 0 12px}
    .brev p{font-family:"Newsreader",serif;font-style:italic;color:var(--muted);max-width:70ch;margin:0 auto;font-size:clamp(1.02rem,1.2vw,1.15rem)}

    main{padding:16px 20px 96px}
    /* Alltid 3-kol layout i størrelse – fyll med usynlige plassholdere */
    .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(1,minmax(0,1fr));max-width:var(--maxw);margin:0 auto}
    @media (min-width:720px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    /* Reveal for mer liv */
    .reveal{opacity:0;transform:translateY(14px) scale(.995)}
    .reveal.is-visible{opacity:1;transform:translateY(0) scale(1);transition:transform var(--in-dur) var(--in-ease),opacity var(--in-dur) var(--in-ease)}

    /* Kort */
    .plate{display:block;position:relative;border-radius:var(--radius);overflow:hidden;text-decoration:none;color:inherit;background:rgba(255,255,255,.55);border:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);transform:translateZ(0);transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;will-change:transform}
    .plate:hover{transform:translateY(-4px);box-shadow:0 16px 32px rgba(0,0,0,.16);border-color:rgba(0,0,0,.12)}

    /* Toppstripe – FARGESYNKET til cover via CSS-variabel */
    .stripe{position:absolute;inset:0 0 auto 0;height:6px;z-index:2;background:linear-gradient(90deg,var(--c1,#222),var(--c2,#666),var(--c3,#aaa));background-size:200% 100%;animation:stripeSlide var(--speed,3s) linear infinite;animation-delay:var(--phase,0ms);-webkit-mask:repeating-linear-gradient(90deg,#000 0 14px,transparent 14px 20px);mask:repeating-linear-gradient(90deg,#000 0 14px,transparent 14px 20px)}
    @keyframes stripeSlide{to{background-position:-200% 0}}

    .cover{width:100%;aspect-ratio:1/1;display:block;object-fit:cover;background:#e9dbc7;filter:contrast(.95) saturate(.95);transition:transform .6s cubic-bezier(.2,.7,.2,1);animation:coverDrift 7s ease-in-out infinite;animation-delay:var(--phase,0ms)}
    .plate:hover .cover{transform:scale(1.03) rotate(.2deg)}
    @keyframes coverDrift{0%,100%{transform:scale(1.01)}50%{transform:scale(1.025)}}

    /* Strammere mellomrom mellom bilde og tittel */
    .meta{padding:10px 14px 14px;background:linear-gradient(180deg, rgba(241,227,207,.6), rgba(241,227,207,.4));border-top:1px solid rgba(0,0,0,.06)}
    .tittel{margin:0 0 6px;font-family:"Archivo Black",sans-serif;font-weight:400;text-transform:uppercase;letter-spacing:.06em;font-size:1.18rem;line-height:1.12;position:relative;transition:letter-spacing .25s ease, transform .25s ease}
    .plate:hover .tittel{letter-spacing:.09em;transform:translateY(-1px)}
    .tittel::after{content:"";position:absolute;left:0;bottom:-3px;height:1px;width:24px;background:currentColor;opacity:.22;transition:width .25s ease, opacity .25s ease}
    .plate:hover .tittel::after{width:36px;opacity:.32}
    .under{margin:0;color:var(--muted);font-size:.98rem;font-family:"Newsreader",serif;font-style:italic;letter-spacing:.01em}

    /* Velkomstoverlay (fade + liten eq) */
    .welcome{position:fixed;inset:0;z-index:999;display:grid;place-items:center;background:rgba(241,227,207,.96);backdrop-filter:saturate(1.1);transition:opacity .6s ease, visibility .6s ease}
    .welcome.hide{opacity:0;visibility:hidden}
    .welcome-card{padding:28px 32px;border-radius:14px;background:rgba(255,255,255,.7);border:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);text-align:center}
    .welcome-card h2{font-family:"Archivo Black",sans-serif;margin:0 0 8px;font-size:1.4rem;letter-spacing:.02em}
    .welcome-eq{height:6px;margin-top:12px;background:linear-gradient(90deg,var(--c1,#222),var(--c2,#666),var(--c3,#aaa));background-size:200% 100%;animation:stripeSlide 3.2s linear infinite;border-radius:999px;-webkit-mask:repeating-linear-gradient(90deg,#000 0 14px,transparent 14px 20px);mask:repeating-linear-gradient(90deg,#000 0 14px,transparent 14px 20px)}

    footer{text-align:center;color:var(--muted);font-size:.95rem;padding: 12px 20px 72px}
    .sweet{display:inline-flex;align-items:center;gap:10px}
    .seed{width:10px;height:10px;border-radius:50%;background:#E25C44;box-shadow:0 0 0 0 rgba(226,92,68,.4);animation:seedPulse 2.6s ease-out infinite}
    @keyframes seedPulse{0%{box-shadow:0 0 0 0 rgba(226,92,68,.4)}70%{box-shadow:0 0 0 12px rgba(226,92,68,0)}100%{box-shadow:0 0 0 0 rgba(226,92,68,0)}}

    .commit{margin-top:18px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:rgba(0,0,0,.04);display:inline-block;padding:10px 12px;border-radius:8px;border:1px solid rgba(0,0,0,.06)}

    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}.reveal{opacity:1;transform:none}.welcome{display:none}}
  </style>
</head>
<body>
  <!-- Velkomst -->
  <div class="welcome" id="welcome">
    <div class="welcome-card">
      <h2>Velkommen</h2>
      <p style="margin:0;color:var(--muted)">Henter spillelister…</p>
      <div class="welcome-eq" id="welcome-eq"></div>
    </div>
  </div>

  <!-- Brev -->
  <header class="brev container" aria-label="Brev fra Marcus til Athina">
    <h1>Kjære Athina</h1>
    <p>Jeg ville lage et lite sted for oss, et sted hvor musikken kan få samle seg, kapittel for kapittel. Når du trykker på listene, håper jeg du kjenner at jeg tenker på deg</p>
  </header>

  <!-- Grid 3-spalter (kort er hele lenker) -->
  <main>
    <section class="grid" id="grid" aria-label="Spillelister"></section>
  </main>

  <footer>
    <span class="sweet"><span class="seed" aria-hidden="true"></span> Laget med omtanke — Marcus</span>
    <div class="commit" id="commit-msg"></div>
  </footer>

  <script>
    async function loadPlaylists(){
      try{
        const res = await fetch('playlist.json', { cache: 'no-cache' });
        const data = await res.json();
        renderPlaylists(Array.isArray(data) ? data : []);
      }catch(err){
        console.error('Kunne ikke laste playlist.json', err);
        renderPlaylists([]);
      }finally{
        setTimeout(()=>document.getElementById('welcome')?.classList.add('hide'), 500);
      }
    }

    // Fjerner prefiks "Kapittel" hvis det finnes
    const clean = (t)=>String(t||'').replace(/^\s*Kapittel\s*/i,'').trim();

    // Ekstraher dominante farger fra cover visuelt via sample (lerret) -> gir 3 kontrastfarger
    function sampleColors(img){
      const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d',{willReadFrequently:true});
      const w=img.naturalWidth, h=img.naturalHeight; const s=64; cvs.width=s; cvs.height=s; ctx.drawImage(img,0,0,s,s);
      const data=ctx.getImageData(0,0,s,s).data; const buckets=[0,0,0,0,0,0]; const cols=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]];
      for(let i=0;i<data.length;i+=4){ const r=data[i],g=data[i+1],b=data[i+2]; const v=Math.max(r,g,b)-Math.min(r,g,b); // enkel kontrastmåling
        const idx = v>80 ? 0 : v>50 ? 1 : v>35 ? 2 : v>20 ? 3 : v>10 ? 4 : 5; buckets[idx]++; cols[idx][0]+=r; cols[idx][1]+=g; cols[idx][2]+=b; }
      const pick=(i)=>{const n=buckets[i]||1; return `rgb(${Math.round(cols[i][0]/n)}, ${Math.round(cols[i][1]/n)}, ${Math.round(cols[i][2]/n)})`};
      return [pick(0),pick(1),pick(2)];
    }

    function renderPlaylists(list){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      // Ingen data -> ikke vis tomt
      if(!list.length){ addSpacers(0); return; }

      // Global synk: bruk første korts farger som base, men hver stripe får faseforskyvning
      let globalColors=['#222','#666','#aaa'];

      list.forEach((pl, idx) => {
        const card = document.createElement('a');
        card.className = 'plate reveal';
        card.href = pl.url; card.target = '_blank'; card.rel = 'noopener';
        card.setAttribute('aria-label', `${clean(pl.title)}: ${pl.subtitle}`);

        const stripe = document.createElement('span'); stripe.className = 'stripe';
        const img = document.createElement('img'); img.className = 'cover'; img.src = pl.cover; img.alt = clean(pl.title) + ' cover'; img.loading = 'lazy'; img.decoding = 'async';

        const meta = document.createElement('div'); meta.className = 'meta';
        const h = document.createElement('h2'); h.className = 'tittel'; h.textContent = clean(pl.title);
        const s = document.createElement('p'); s.className = 'under'; s.textContent = pl.subtitle;
        meta.append(h,s);
        card.append(stripe, img, meta);
        grid.appendChild(card);

        // Når bildet er lastet: sample farger og sett CSS-variabler
        img.addEventListener('load', ()=>{
          const [c1,c2,c3] = sampleColors(img);
          if(idx===0){ globalColors=[c1,c2,c3]; // global synk fra første cover
            document.documentElement.style.setProperty('--c1', c1);
            document.documentElement.style.setProperty('--c2', c2);
            document.documentElement.style.setProperty('--c3', c3);
            const eq = document.getElementById('welcome-eq'); if(eq){ eq.style.setProperty('--c1', c1); eq.style.setProperty('--c2', c2); eq.style.setProperty('--c3', c3); }
          }
          // Sett kortspesifikke – men bind til global base med svak miks for samkjørt uttrykk
          stripe.style.setProperty('--c1', c1);
          stripe.style.setProperty('--c2', c2);
          stripe.style.setProperty('--c3', c3);
        });

        // Samlet flyt: fase/speed bindes til index så alle beveger seg i orkestrert mønster
        const phase = (idx * 140) + 'ms';
        const speed = (3 + (idx % 3)*0.2) + 's';
        card.style.setProperty('--phase', phase);
        card.style.setProperty('--speed', speed);

        // Subtil parallax ved mus
        card.addEventListener('mousemove', (e) => {
          const r = card.getBoundingClientRect();
          const dx = ((e.clientX - r.left) / r.width - 0.5) * 2;
          const dy = ((e.clientY - r.top) / r.height - 0.5) * 2;
          img.style.transform = `scale(1.03) translate(${dx*4}px, ${dy*4}px) rotate(${dx*.3}deg)`;
        });
        card.addEventListener('mouseleave', () => { img.style.transform = ''; });
      });

      addSpacers(list.length);
      revealInViewport();
    }

    function addSpacers(len){
      const grid = document.getElementById('grid');
      if(len===0){
        // 3 usynlige plassholdere for å holde rytmen selv helt tomt
        for(let i=0;i<3;i++){ const sp=document.createElement('div'); sp.className='plate'; sp.style.visibility='hidden'; sp.style.pointerEvents='none'; grid.appendChild(sp);} return;
      }
      const remainder = len % 3; if(remainder){ for(let i=0;i<3-remainder;i++){ const sp=document.createElement('div'); sp.className='plate'; sp.style.visibility='hidden'; sp.style.pointerEvents='none'; grid.appendChild(sp);} }
    }

    function revealInViewport(){
      const obs = new IntersectionObserver((entries,o)=>{ entries.forEach(en=>{ if(en.isIntersecting){ en.target.classList.add('is-visible'); o.unobserve(en.target); } }); }, { threshold:.12 });
      document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
    }

    // Commit
    const commit = `feat(playlists): cover-synkede stripefarger, orkestrert fasedrift, velkomstoverlay med EQ, 3-kol placeholders (#ui)`;
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('commit-msg')?.textContent = commit;
      loadPlaylists();
    });
  </script>
</body>
</html>
